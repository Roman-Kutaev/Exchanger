<!DOCTYPE html>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    th, td {
        width: 150px;
        border: 1px solid darkgreen;
        text-align: center;
    }

    table, div {
        width: 900px;
        text-align: center;
        border: 1px solid green;
        margin: auto;
    }


</style>
<body>
<br>

<div id="calculateForm">
    <input hidden id="buyId">
    <input id="buyCc" disabled>
    <label><select id="act">
        <option>Покупка</option>
        <option>Продажа</option>
    </select></label>
    <input id="sumBuy" required="required">
    <label for="phone"></label><input id="phone" name="phone" required="required">
    <button id="calculate">Подать заявку</button>
</div>
<div name="rs" id="requestSave">
<!--    <input id="updateID">-->
</div>
<br>
<hr>
<table>
    <thead>
    <tr>
        <td>Валюта</td>
        <td>Курс покупки</td>
        <td>Курс продажи</td>
        <td>Дата</td>
    </tr>
    </thead>
    <tbody id="body">
    </tbody>
</table>
<script>

    const baseUrl = "http://localhost:8080/api/v1/exchanger";

    fetch(baseUrl)
        .then(response => response.json())
        .then(json => {
            displayRates(json);
        });

    function displayRates(currencyArr) {
        console.log(currencyArr);
        const tbody = document.querySelector('#body');
        tbody.innerHTML = '';
        currencyArr.forEach(currency => {
            let tr = document.createElement('tr');
            for (const prop in currency) {
                if (prop !== 'id') {
                    let td = document.createElement('td');
                    td.append(document.createTextNode(currency[prop]));
                    tr.append(td);
                }
            }
            tr.append(addButtonExchange(currency.cc));
            tbody.append(tr);
        });
    }

    function addButtonExchange(cc) {
        let td = document.createElement('td');
        let buttonElement = document.createElement("button");
        buttonElement.className = "buy";
        buttonElement.setAttribute("rateCc", cc);
        const text = document.createTextNode("Заявка на обмен " + cc);
        buttonElement.append(text);
        td.append(buttonElement)
        return td;
    }

    $('tbody').on('click', '.buy', function () {
        let cc = $(this).attr("rateCc");
        console.log(cc);
        fetch(baseUrl + "/" + cc, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
            .then(json => {
                document.querySelector('#buyCc').value = json.cc;
            })
    })

    const baseUrlRequest = "http://localhost:8080/api/v1/exchanger/request";

    document.querySelector("#calculate")
        .addEventListener('click', event => {
            let ccValue = document.querySelector('#buyCc');
            let actionValue = document.querySelector('#act');
            let sumValue = document.querySelector('#sumBuy');
            let phoneNumberValue = document.querySelector('#phone');
            const request = {
                cc: ccValue.value,
                action: actionValue.value,
                sumCurrency: sumValue.value,
                phoneNumber: phoneNumberValue.value
            };
            fetch(baseUrlRequest, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
            }).then(response => response.json())
                .then(json => {
                    // ccValue.value = sumValue.value = phoneNumberValue.value = '';
                    displayRequest(json);
                })
        });


    function displayRequest(request) {
        console.log(request);
        console.log(request.id);
        const form = document.querySelector('#requestSave');
        form.innerHTML = '';
        let div = document.createElement('div');
        for (const prop in request) {
            if (prop === 'sumPayment') {
                let p = document.createElement('p');
                p.append(document.createTextNode("Сумма к оплате " + request[prop] + " грн."));
                p.className = 'sumPayment';
                div.append(p);
            } else if (prop === 'phoneNumber') {
                let p = document.createElement('p');
                p.append(document.createTextNode("СМС отправлено на номер " + request[prop]));
                p.className = prop;
                div.append(p);
            } else if (prop === 'id'){
                console.log(request[prop]);
               document.querySelector('#buyId').value = request[prop];
            }
        }
        let label = document.createElement('label');
        label.append(document.createTextNode('Код: '));
        let input = document.createElement('input');
        let buttonElement = document.createElement("button");
        buttonElement.className = "save";
        const text = document.createTextNode("Подтвердить заявку");
        buttonElement.append(text);
        div.append(label, input, buttonElement);
        form.append(div);
    }

    $('div').on('click', '.save', function () {
        const form = document.querySelector('#requestSave');
        let code = form.getElementsByTagName('input')[0].value
        console.log(code)
        let id = document.querySelector('#buyId').value;
        let ccValue = document.querySelector('#buyCc');
        let actionValue = document.querySelector('#act');
        let sumValue = document.querySelector('#sumBuy');
        let phoneNumberValue = document.querySelector('#phone');
        const request = {
            id: id,
            confirmationCode:code,
            cc: ccValue.value,
            action: actionValue.value,
            sumCurrency: sumValue.value,
            phoneNumber: phoneNumberValue.value
        };
        console.log(request)
        fetch(baseUrlRequest + "/" + id, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(request)
        }).then(response => {
            ccValue.value = sumValue.value = phoneNumberValue.value = '';
            form.innerHTML = '';
        })
    });

</script>
</body>
</html>